#!/bin/bash

PSQL=psql
SUPERUSER=postgres
MASKED_ROLE=test_dnfvdjlsfjdsnfjd
MASKED_ROLE_PWD=vkskf345GRGEKF404
DB_SOURCE=test_sdvicsdfea232eddef


$PSQL << EOSQL
  CREATE DATABASE $DB_SOURCE;
  ALTER DATABASE $DB_SOURCE SET session_preload_libraries = 'anon';
EOSQL

$PSQL $DB_SOURCE << EOSQL
  BEGIN;
  CREATE ROLE $MASKED_ROLE LOGIN PASSWORD '$MASKED_ROLE_PWD';
  CREATE EXTENSION anon CASCADE;
  ALTER DATABASE $DB_SOURCE SET anon.transparent_dynamic_masking TO true;
  CREATE TABLE people AS SELECT 'John' AS firstname;
  GRANT USAGE ON SCHEMA public TO $MASKED_ROLE;
  GRANT SELECT ON ALL TABLES IN SCHEMA public TO $MASKED_ROLE;
  GRANT USAGE ON SCHEMA anon TO $MASKED_ROLE;
  GRANT SELECT ON ALL TABLES IN SCHEMA anon TO $MASKED_ROLE;
  GRANT SELECT ON ALL SEQUENCES IN SCHEMA anon TO $MASKED_ROLE;
  SECURITY LABEL FOR anon ON COLUMN people.firstname
  IS 'MASKED WITH VALUE ''Robert'' ';
  SECURITY LABEL FOR anon ON ROLE $MASKED_ROLE IS 'MASKED';
  COMMIT;
EOSQL

##
## Dump & Restore
##

export PGDATABASE=$DB_SOURCE
export PGUSER=$MASKED_ROLE
export PGPASSWORD=$MASKED_ROLE_PWD

pg_dump --extension=plpgsql $DB_SOURCE

# clean up
export PGUSER=postgres
dropdb $DB_SOURCE
dropuser $MASKED_ROLE

